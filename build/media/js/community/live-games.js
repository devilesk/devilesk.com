$.getJSON("/media/json/sourceTVGames.json", function(data) {
	//var data = {"games":[{"sourceTvPublicAddr":2453837957,"sourceTvPrivateAddr":2453837957,"sourceTvPort":28054,"goodPlayers":[{"steamId":"76561198053977899","name":"Virtus.pro > NS","heroId":42},{"steamId":"76561197981531669","name":"Fnatic.H4nn1","heroId":10},{"steamId":"76561198077687195","name":"SoNNeikO_of The Laputa!","heroId":50},{"steamId":"76561198094180574","name":"INFY","heroId":7},{"steamId":"76561198047485124","name":"123","heroId":17}],"badPlayers":[{"steamId":"76561198046966189","name":"w33","heroId":82},{"steamId":"76561198078942225","name":"#yu'r MAMA s0 DOPEEE","heroId":9},{"steamId":"76561198073538109","name":"SANKE #fucking tornado#","heroId":46},{"steamId":"76561198051935657","name":"ProGamer","heroId":69},{"steamId":"76561198049091790","name":"Rajjix|oT.M","heroId":99}],"numSpectators":632,"tournamentId":0,"tournamentGameId":0,"towerState":4073471,"tvBroadcastTime":1210.8931884765625,"gameTime":878.3580322265625,"serverSteamid":"90090065311643652","leagueid":0,"gameMode":"DOTA_GAMEMODE_AP","lobbyType":7},{"sourceTvPublicAddr":2453837906,"sourceTvPrivateAddr":2453837906,"sourceTvPort":28022,"goodPlayers":[{"steamId":"76561198049420019","name":"Kaibutsu","heroId":0},{"steamId":"76561198060432638","name":"Satoshi NAkamato","heroId":0},{"steamId":"76561198112024171","name":"gottaloveya","heroId":0},{"steamId":"76561198032505275","name":"1234","heroId":0},{"steamId":"76561198032578355","name":"RCTIC.XD","heroId":0}],"badPlayers":[{"steamId":"76561197997630606","name":"7uPx","heroId":0},{"steamId":"76561198084053252","name":"??????","heroId":0},{"steamId":"76561198051635410","name":"Risa","heroId":0},{"steamId":"76561198023153253","name":"EG.X!!","heroId":0},{"steamId":"76561198081263996","name":"Mini","heroId":0}],"numSpectators":0,"tournamentId":0,"tournamentGameId":0,"towerState":4194303,"tvBroadcastTime":-16.398090362548828,"serverSteamid":"90090065444669441","leagueid":0,"gameMode":"DOTA_GAMEMODE_AP","lobbyType":7},{"sourceTvPublicAddr":2453838169,"sourceTvPrivateAddr":2453838169,"sourceTvPort":28035,"goodPlayers":[{"steamId":"76561198065341384","name":"kot_alex","heroId":69},{"steamId":"76561197982830459","name":"JOIN THE RICE!!!","heroId":110},{"steamId":"76561197986948192","name":"keepo","heroId":87},{"steamId":"76561198057856286","name":"xaxa","heroId":44},{"steamId":"76561197980503327","name":"MYM LINK","heroId":17}],"badPlayers":[{"steamId":"76561198064321025","name":"insol3n7","heroId":58},{"steamId":"76561198062006583","name":"PoisoN","heroId":30},{"steamId":"76561198064170499","name":"asdasdasdasdasdasdasdasdasdasd","heroId":96},{"steamId":"76561198090701535","name":"Mr.Nosyan","heroId":45},{"steamId":"76561197987780011","name":"SaloiG","heroId":41}],"numSpectators":78,"tournamentId":0,"tournamentGameId":0,"towerState":4056838,"tvBroadcastTime":1748.868408203125,"gameTime":1557.7244873046875,"serverSteamid":"90090065358387204","leagueid":0,"gameMode":"DOTA_GAMEMODE_AP","lobbyType":7},{"sourceTvPublicAddr":2453838665,"sourceTvPrivateAddr":2453838665,"sourceTvPort":28072,"goodPlayers":[{"steamId":"76561198053911129","name":"Str33tlevel","heroId":74},{"steamId":"76561198013903631","name":"murdok_","heroId":88},{"steamId":"76561198049300161","name":"mes___","heroId":51},{"steamId":"76561198047153026","name":"hardlinerikimaru","heroId":14},{"steamId":"76561198047179839","name":"estonian","heroId":11}],"badPlayers":[{"steamId":"76561197982976553","name":"knock knock","heroId":6},{"steamId":"76561197962993643","name":"OmgzpwnD","heroId":50},{"steamId":"76561198049915877","name":"electroduck///","heroId":65},{"steamId":"76561198055264128","name":"Petricko","heroId":9},{"steamId":"76561198074344767","name":"Br1ngMe2L1fe","heroId":95}],"numSpectators":55,"tournamentId":0,"tournamentGameId":0,"towerState":4194230,"tvBroadcastTime":1341.898681640625,"gameTime":1105.660400390625,"serverSteamid":"90090065264669703","leagueid":0,"gameMode":"DOTA_GAMEMODE_AP","lobbyType":7},{"sourceTvPublicAddr":2453838177,"sourceTvPrivateAddr":2453838177,"sourceTvPort":28066,"goodPlayers":[{"steamId":"76561198126994188","name":"Lord Solar Macharius","heroId":53},{"steamId":"76561198129346043","name":"Nolife2","heroId":41},{"steamId":"76561198078048491","name":"???s_KING","heroId":61},{"steamId":"76561198131553006","name":"asdzxc","heroId":86},{"steamId":"76561198131432572","name":"DIRTY WHORE","heroId":97}],"badPlayers":[{"steamId":"76561198046964005","name":"905 elo ez","heroId":88},{"steamId":"76561197997437593","name":"RedOrc.","heroId":34},{"steamId":"76561197999037252","name":"NooLa","heroId":104},{"steamId":"76561198052006984","name":"Interritus (@yarintheslayer)","heroId":110},{"steamId":"76561198123788401","name":"__!","heroId":9}],"numSpectators":61,"tournamentId":0,"tournamentGameId":0,"towerState":4194303,"tvBroadcastTime":616.4613037109375,"gameTime":364.294677734375,"serverSteamid":"90090064964760582","leagueid":0,"gameMode":"DOTA_GAMEMODE_AP","lobbyType":0},{"sourceTvPublicAddr":2453837865,"sourceTvPrivateAddr":2453837865,"sourceTvPort":28035,"goodPlayers":[{"steamId":"76561198114473799","name":"q^","heroId":96},{"steamId":"76561198005726039","name":"heartless_muted","heroId":101},{"steamId":"76561197989603200","name":"standin La Trique","heroId":106},{"steamId":"76561198060110736","name":"Crio_J ???","heroId":58},{"steamId":"76561197977034951","name":"S Paris","heroId":6}],"badPlayers":[{"steamId":"76561197966464875","name":"davy","heroId":25},{"steamId":"76561198047159094","name":"-T_J","heroId":54},{"steamId":"76561198040691427","name":"sQuO","heroId":51},{"steamId":"76561198047254811","name":"HipHopopotamus","heroId":34},{"steamId":"76561198027254659","name":"Levi- ? Apu","heroId":87}],"numSpectators":19,"tournamentId":0,"tournamentGameId":0,"towerState":4046847,"tvBroadcastTime":1014.8817749023438,"gameTime":772.8568115234375,"serverSteamid":"90090064729498630","leagueid":0,"gameMode":"DOTA_GAMEMODE_AP","lobbyType":7}],"numTotalGames":200,"date":1396820209734}
	var heroid = {"1":"antimage","2":"axe","3":"bane","4":"bloodseeker","5":"crystal_maiden","6":"drow_ranger","7":"earthshaker","8":"juggernaut","9":"mirana","10":"morphling","11":"nevermore","12":"phantom_lancer","13":"puck","14":"pudge","15":"razor","16":"sand_king","17":"storm_spirit","18":"sven","19":"tiny","20":"vengefulspirit","21":"windrunner","22":"zuus","23":"kunkka","25":"lina","26":"lion","27":"shadow_shaman","28":"slardar","29":"tidehunter","30":"witch_doctor","31":"lich","32":"riki","33":"enigma","34":"tinker","35":"sniper","36":"necrolyte","37":"warlock","38":"beastmaster","39":"queenofpain","40":"venomancer","41":"faceless_void","42":"skeleton_king","43":"death_prophet","44":"phantom_assassin","45":"pugna","46":"templar_assassin","47":"viper","48":"luna","49":"dragon_knight","50":"dazzle","51":"rattletrap","52":"leshrac","53":"furion","54":"life_stealer","55":"dark_seer","56":"clinkz","57":"omniknight","58":"enchantress","59":"huskar","60":"night_stalker","61":"broodmother","62":"bounty_hunter","63":"weaver","64":"jakiro","65":"batrider","66":"chen","67":"spectre","68":"ancient_apparition","69":"doom_bringer","70":"ursa","71":"spirit_breaker","72":"gyrocopter","73":"alchemist","74":"invoker","75":"silencer","76":"obsidian_destroyer","77":"lycan","78":"brewmaster","79":"shadow_demon","80":"lone_druid","81":"chaos_knight","82":"meepo","83":"treant","84":"ogre_magi","85":"undying","86":"rubick","87":"disruptor","88":"nyx_assassin","89":"naga_siren","90":"keeper_of_the_light","91":"wisp","92":"visage","93":"slark","94":"medusa","95":"troll_warlord","96":"centaur","97":"magnataur","98":"shredder","99":"bristleback","100":"tusk","101":"skywrath_mage","102":"abaddon","103":"elder_titan","104":"legion_commander","106":"ember_spirit","107":"earth_spirit","108":"abyssal_underlord","109":"terrorblade","110":"phoenix"}
	var minimap_bg = new Image();
	minimap_bg.src = '/media/images/dota_minimap_sm.png'
	minimap_bg.onload = function() {
		init();
	};
	console.log(data.date);
	var now = new Date().getTime();
	var offset = now - data.date;
	console.log('now',now);
	console.log('offset',offset/1000);
	console.log(now - data.date);
	console.log(new Date(data.date));
	$('#content').append(
		$('<div>').addClass('row').append(
			$('<div>').addClass('col-md-12').append(
				$('<span>').html('Last updated ')
			).append(
				createTimeElement(offset/1000)
			).append(
				$('<span>').html(' ago, ' + new Date(data.date))
			)
		)
	);
	console.log(new Date(now));
	console.log(new Date(data.date + offset));
	var towerCoords = {
		11: {x:25,y:160,color:'#5DFC0A'},
		12: {x:35,y:170,color:'#5DFC0A'},
		
		19: {x:20,y:140,color:'#5DFC0A'},
		20: {x:20,y:110,color:'#5DFC0A'},
		21: {x:20,y:80,color:'#5DFC0A'},
		
		16: {x:43,y:150,color:'#5DFC0A'},
		17: {x:60,y:135,color:'#5DFC0A'},
		18: {x:80,y:115,color:'#5DFC0A'},
		
		13: {x:55,y:175,color:'#5DFC0A'},
		14: {x:95,y:175,color:'#5DFC0A'},
		15: {x:160,y:175,color:'#5DFC0A'},
		
		0: {x:165,y:30,color:'#FF0000'},
		1: {x:175,y:40,color:'#FF0000'},
		
		8: {x:145,y:30,color:'#FF0000'},
		9: {x:100,y:30,color:'#FF0000'},
		10: {x:35,y:30,color:'#FF0000'},
		
		5: {x:150,y:53,color:'#FF0000'},
		6: {x:130,y:75,color:'#FF0000'},
		7: {x:110,y:95,color:'#FF0000'},
		
		2: {x:177,y:63,color:'#FF0000'},
		3: {x:177,y:100,color:'#FF0000'},
		4: {x:177,y:123,color:'#FF0000'}
	}
	console.log(data);

	function createTimeElement(gameTime) {
		var timeElement = $('<span>');
		var t = gameTime;
		var time = {
			seconds:Math.floor(t % 60),
			minutes:Math.floor(t / 60),
			hours:Math.floor(t / 60 / 60)
		}
		timeElement.html(getTimeString(t));
		setInterval(function() {
			console.log('timer');
			t++;

			timeElement.html(getTimeString(t));
		},1000);
		return timeElement;
	}

	function getTimeString(t) {
		var time = {}
		time.seconds = Math.floor(t % 60);
		time.minutes = Math.floor(t / 60 % 60);
		time.hours = Math.floor(t / 60 / 60);
		var s = '';
		if (time.hours) s = time.hours + ':';
		if (time.minutes) {
			s += pad(time.minutes,2) + ':';
		}
		else {
			s += '00:';
		}
		if (time.seconds) {
			s += pad(time.seconds,2) + ':';
		}
		else {
			s += '00:';
		}
		s = s.substring(0,s.length-1);
		return s
	}

	function pad(num, size) {
		var s = num+"";
		while (s.length < size) s = "0" + s;
		return s;
	}

	function init() {
		for (var i=0;i<data.games.length;i++) {
			var game = data.games[i];
			var gameTime = parseFloat(game.gameTime) + offset/1000;
			var mode = game.gameMode;
			if (mode == 'DOTA_GAMEMODE_AP') {
				mode = 'All Pick'
			}
			var time = {
				seconds:Math.floor(gameTime % 60),
				minutes:Math.floor(gameTime / 60),
				hours:Math.floor(gameTime / 60 / 60)
			}
			console.log('time',gameTime);
			console.log('time',time);
			
			var timeElement = createTimeElement(gameTime);
			var tbody_players = $('<tbody>')
			var tbody_info = $('<tbody>')
			
			tbody_info.append(
				$('<tr>').append(
					$('<td>').addClass('col-md-6').html('Spectators: ')
				).append(
					$('<td>').addClass('col-md-6').html(game.numSpectators)
				)
			).append(
				$('<tr>').append(
					$('<td>').addClass('col-md-6').html('Mode: ')
				).append(
					$('<td>').addClass('col-md-6').html(mode)
				)
			).append(
				$('<tr>').append(
					$('<td>').addClass('col-md-6').html('Time: ')
				).append(
					timeElement
				)
			);
			
			var info = $('<div>')
			info.append(
				$('<div>').addClass('col-md-3').append(
					$('<span>').html('Mode: ')
				).append(
					$('<span>').html(mode)
				)
			).append(
				$('<div>').addClass('col-md-3').addClass('text-center').append(
					$('<span>').html('Time: ')
				).append(
					timeElement
				)
			).append(
				$('<div>').addClass('col-md-3').addClass('text-right').append(
					$('<span>').html('Spectators: ')
				).append(
					$('<span>').html(game.numSpectators)
				)
			);
			
			for (var j=0;j<5;j++) {
				console.log('good',getSteamId(game.goodPlayers[j].steamId));
				console.log('bad',getSteamId(game.badPlayers[j].steamId));
				tbody_players.append(
					$('<tr>').append(
						$('<td>').addClass('col-md-1').append($('<div>').addClass('miniherosprite').addClass('miniherosprite-'+heroid[game.goodPlayers[j].heroId]))
					).append(
						$('<td>').addClass('col-md-5').append(
							$('<a>').attr('href','http://dotabuff.com/players/' + getSteamId(game.goodPlayers[j].steamId)).html(game.goodPlayers[j].name)
						)
					).append(
						$('<td>').addClass('col-md-5').addClass('text-right').append(
							$('<a>').attr('href','http://dotabuff.com/players/' + getSteamId(game.badPlayers[j].steamId)).html(game.badPlayers[j].name)
						)
					).append(
						$('<td>').addClass('col-md-1').append($('<div>').addClass('miniherosprite').addClass('miniherosprite-'+heroid[game.badPlayers[j].heroId]))
					)
				);
			}
			
			var canvas = $('<canvas>').width(200).height(200).attr('width',200).attr('height',200);
			var context = canvas[0].getContext('2d');
			var towerState = game.towerState.toString(2);
			//console.log(towerState.length);
			context.drawImage(minimap_bg, 0, 0);
			for (var j=0;j<22;j++) {
				if (towerState[j] == '1') {
					context.beginPath();
					context.arc(towerCoords[j].x, towerCoords[j].y, 5, 0, 2 * Math.PI, false);
					context.closePath();
					context.fillStyle = towerCoords[j].color;
					context.fill();
				}
				else {
					//console.log('n');
				}

			}
			
			$('#content').append(
				$('<div>').addClass('panel').addClass('row').append(
					$('<div>').addClass('panel-heading').append(
						info
					)
				).append(
					$('<div>').addClass('panel-body').append(
					/*	$('<div>').addClass('col-md-3').append(
							$('<table>').addClass('table').append(
								$('<thead>')
							)
							.append(
								tbody_info
							)
						)
					).append(*/
						$('<div>').addClass('col-md-9').append(
							$('<table>').addClass('table').append(
								$('<thead>')
							)
							.append(
								tbody_players
							)
						)
					).append(
						$('<div>').addClass('col-md-3').append(
							$('<div>').addClass('canvasContainer').append(
								canvas
							)
						)
					)
				)
			);
			console.log('test');
		}
	}

	function isOdd(s) {
		switch (s.slice(-1)) {
			case '1':
			case '3':
			case '5':
			case '7':
			case '9':
				return true;
			break;
			default:
				return false;
			break;
		}
	}

	function divByTwo(s) {
		var new_s = '',
			next_add = 0,
			add;
		for (i in s) {
			var ch = s[i];
			//console.log(ch);
			add = next_add;
			if (isOdd(ch)) {
				next_add = 5;
			}
			else {
				next_add = 0;
			}
			//console.log('next_add',next_add);
			new_ch = (Math.floor(parseInt(ch)/2)+add).toString();
			//console.log(new_ch + ' ',new_s);
			new_s = new_s + new_ch;
		}
		if (new_s != '0') {
			if (new_s.charAt(0) == '0') new_s = new_s.slice(1);
		}
		//console.log(new_s);
		return new_s
	}

	function getSteamId(num) {
		stack = '';
		//console.log(num);
		while (num != '0') {
			if (isOdd(num)) {
				stack = '1' + stack;
			}
			else {
				stack = '0' + stack;
			}
			num = divByTwo(num);
		}
		//console.log(stack);
		//console.log(stack.slice(-32));
		result = 0;
		for (var i=0;i<32;i++) {
			if (stack.slice(-32).charAt(32-i-1) == '1') {
				result += Math.pow(2,i);
			}
		}
		//console.log(result);
		return result;
	}
});